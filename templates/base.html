<!DOCTYPE html>
<html>
<head>
    <title>Video Streaming & Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

        .container { display: flex; gap: 20px; }
        .left_column { flex: 1; }
        .right_column { flex: 1; }
        canvas { width: 100% !important; max-width: 1000px; height: auto; margin-bottom: 20px; border: 1px solid #ccc; }

    </style>
</head>
<body>
    <div class="container">
        
        <div class="left_column">
            

            <h1> 五股交流道目前車況  </h1>
            <canvas id="canvas_format_image" width="352" height="240" alt='stream_video'></canvas>
            <img id="stream_video" src="{% url 'stream_video' %}" style="display: none;">
        
        </div>
        <div class="right_column">
            <h1> 及時車流量 </h1>
            <canvas id="ins_car_barChart_l" width="300" height="200"></canvas>
            <canvas id="ins_car_barChart_r" width="300" height="200"></canvas>
            
            <h2> 累積車流量</h2>
            <canvas id="cul_car_barchart_l" width="300" height="200"></canvas>
            <canvas id="cul_car_barchart_r" width="300" height="200"></canvas>
        
        </div>
    </div>

    <script>

        const canvas1 = document.getElementById('canvas_format_image');
        const ctx1 = canvas1.getContext('2d');
        const video = document.getElementById('stream_video');

        // Detection data storage
        let detectionData = { xyxy: [], confidence: [], class_id: [] };

        // Annotation settings
        const lineZone = { start: { x: 70, y: 170 }, end: { x: 320, y: 170 } };
        const polygon1 = [[100, 240], [325, 240], [170, 150], [80, 150]];
        const polygon2 = [[330, 240], [352, 175], [270, 150], [180, 150]];

        function drawFrame() {
            try {
                // Draw video frame
                ctx1.drawImage(video, 0, 0, canvas1.width, canvas1.height);

                // Draw bounding boxes
                ctx1.strokeStyle = 'red';
                ctx1.lineWidth = 2;

                detectionData.xyxy.forEach(([x1, y1, x2, y2]) => {
                    ctx1.strokeRect(x1, y1, x2 - x1, y2 - y1);
                });

                // Draw line zone
                ctx1.beginPath();
                ctx1.moveTo(lineZone.start.x, lineZone.start.y);
                ctx1.lineTo(lineZone.end.x, lineZone.end.y);
                ctx1.strokeStyle = 'blue';
                ctx1.stroke();

                // Draw polygon zones
                ctx1.beginPath();
                ctx1.moveTo(polygon1[0][0], polygon1[0][1]);
                polygon1.forEach(([x, y]) => ctx1.lineTo(x, y));
                ctx1.closePath();
                ctx1.strokeStyle = 'green';
                ctx1.stroke();

                ctx1.beginPath();
                ctx1.moveTo(polygon2[0][0], polygon2[0][1]);
                polygon2.forEach(([x, y]) => ctx1.lineTo(x, y));
                ctx1.closePath();
                ctx1.strokeStyle = 'purple';
                ctx1.stroke();

                requestAnimationFrame(drawFrame);
            } catch (error) {
                console.error('Error drawing frame:', error);
            }
        }


        drawFrame();


        video.onerror = function() {
            console.error('Failed to load stream');
        };

        // Fetch detection data and 
        function fetchDetectionData() {
            fetch("{% url 'get_data' %}")
                .then(response => response.json())
                .then(data => {
                    detectionData = data;  // Update detection data
                })
                .catch(error => console.error('Error fetching detection data:', error));
        }

        setInterval(fetchDetectionData, 500);

        
        // Define your custom update interval here (in milliseconds)

        // Instant bar charts
        const ins_barCtx_left = document.getElementById('ins_car_barChart_l').getContext('2d');
        const ins_barCtx_right = document.getElementById('ins_car_barChart_r').getContext('2d');

        const ins_barChart_l = new Chart(ins_barCtx_left, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{ label: '左車道', data: [], backgroundColor: 'blue' }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        const ins_barChart_r = new Chart(ins_barCtx_right, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{ label: '右車道', data: [], backgroundColor: 'red' }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // Cumulative bar charts
        const cul_barCtx_left = document.getElementById('cul_car_barchart_l').getContext('2d');
        const cul_barCtx_right = document.getElementById('cul_car_barchart_r').getContext('2d');

        const cul_barchart_l = new Chart(cul_barCtx_left, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{ label: '左車道', data: [], backgroundColor: 'blue' }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        const cul_barchart_r = new Chart(cul_barCtx_right, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{ label: '右車道', data: [], backgroundColor: 'red' }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // Function to fetch and update chart data
        function updateCharts() {
            fetch("{% url 'get_data' %}")
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Instant car count left road
                    ins_barChart_l.data.labels = data.datetime;
                    ins_barChart_l.data.datasets[0].data = data.polygon1count;
                    ins_barChart_l.update();

                    // Instant car count right road
                    ins_barChart_r.data.labels = data.datetime;
                    ins_barChart_r.data.datasets[0].data = data.polygon2count;
                    ins_barChart_r.update();

                    // Cumulative car count
                    cul_barchart_l.data.labels = data.dates;
                    cul_barchart_l.data.datasets[0].data = data.linecount1;
                    cul_barchart_l.update();

                    cul_barchart_r.data.labels = data.dates;
                    cul_barchart_r.data.datasets[0].data = data.linecount2;
                    cul_barchart_r.update();
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Set the interval to your custom time
        setInterval(updateCharts,5000); // goal is to wait data to load 
       
        
    </script>
</body>
</html>















